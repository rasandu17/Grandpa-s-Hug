<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grandpa's Hug - Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        background: linear-gradient(to bottom, #e3f2fd, #fff);
        text-align: center;
      }
      h1 {
        color: #1976d2;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 15px 32px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin: 10px;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      button.recording {
        background-color: #f44336;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      #status {
        margin: 20px 0;
        padding: 15px;
        background: white;
        border-radius: 8px;
        min-height: 50px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <h1>üë¥ Grandpa's Hug - Voice Test</h1>
    <p>please press the button</p>

    <button id="recordBtn" onclick="toggleRecording()">üé§ Record & Ask</button>
    <button
      id="stopBtn"
      onclick="stopRecording()"
      disabled
      style="background-color: #f44336"
    >
      ‚èπ Stop
    </button>

    <div class="loader" id="loader"></div>
    <div id="status">Ready to record...</div>

    <audio
      id="responseAudio"
      controls
      style="margin-top: 20px; display: none; width: 100%"
    ></audio>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;

      async function toggleRecording() {
        if (!isRecording) {
          try {
            console.log("Requesting microphone access...");
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });

            console.log("Microphone access granted");

            // Check supported MIME types
            let mimeType = "audio/webm";
            if (!MediaRecorder.isTypeSupported(mimeType)) {
              mimeType = "audio/mp4";
              if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = "";
              }
            }

            console.log("Using MIME type:", mimeType || "default");

            mediaRecorder = new MediaRecorder(
              stream,
              mimeType
                ? {
                    mimeType: mimeType,
                  }
                : {}
            );

            mediaRecorder.ondataavailable = (event) => {
              console.log("Data available:", event.data.size, "bytes");
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
              console.log("Recording stopped, chunks:", audioChunks.length);
              const audioBlob = new Blob(audioChunks, {
                type: mimeType || "audio/webm",
              });
              console.log("Audio blob size:", audioBlob.size);
              audioChunks = [];
              await sendAudioToBackend(audioBlob);
              stream.getTracks().forEach((track) => track.stop());
            };

            mediaRecorder.start();
            console.log("Recording started");
            isRecording = true;
            document.getElementById("recordBtn").classList.add("recording");
            document.getElementById("recordBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;
            document.getElementById("status").textContent =
              "üéô Recording... Speak now!";
          } catch (err) {
            console.error("Recording error:", err);
            document.getElementById("status").textContent =
              "‚ùå Error: " +
              err.message +
              " - Please allow microphone permission!";
            alert(
              "Microphone access denied!\n\nPlease:\n1. Click the üîí lock icon in browser address bar\n2. Allow microphone permission\n3. Refresh the page"
            );
          }
        }
      }

      function stopRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          isRecording = false;
          document.getElementById("recordBtn").classList.remove("recording");
          document.getElementById("recordBtn").disabled = false;
          document.getElementById("stopBtn").disabled = true;
          document.getElementById("status").textContent =
            "‚è∏ Recording stopped. Processing...";
        }
      }

      async function sendAudioToBackend(audioBlob) {
        const formData = new FormData();
        formData.append("file", audioBlob, "recording.webm");

        document.getElementById("loader").style.display = "block";
        document.getElementById("status").textContent =
          "‚è≥ Grandpa is thinking...";

        try {
          const response = await fetch("http://127.0.0.1:8000/chat-audio", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);

          const audioElement = document.getElementById("responseAudio");
          audioElement.src = audioUrl;
          audioElement.style.display = "block";
          audioElement.play();

          document.getElementById("status").textContent =
            "‚úÖ Grandpa replied! Listen above üëÜ";
        } catch (error) {
          document.getElementById("status").textContent =
            "‚ùå Error: " + error.message;
          console.error("Error:", error);
        } finally {
          document.getElementById("loader").style.display = "none";
        }
      }
    </script>
  </body>
</html>
